<div class="billing-container">
  <div class="billing-container__actions">
    <h2>Facturación</h2>
    <div class="billing-container__tabs">
      <button
        [class.active]="activeView === 'invoices'"
        (click)="setActiveView('invoices')"
      >
        Facturas
      </button>
      <button
        [class.active]="activeView === 'create'"
        (click)="setActiveView('create')"
      >
        Crear Factura
      </button>
      <button
        [class.active]="activeView === 'reports'"
        (click)="setActiveView('reports')"
      >
        Reportes
      </button>
    </div>
    <div class="billing-container__search" *ngIf="activeView === 'invoices'">
      <div class="search-input">
        <svg width="20" height="20">
          <use xlink:href="../../../assets/icons/icons.svg#search"></use>
        </svg>
        <input
          type="text"
          placeholder="Buscar facturas..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        />
      </div>
      <div class="filter-dropdown">
        <button (click)="toggleFilterMenu()" class="filter-button">
          <svg width="20" height="20">
            <use xlink:href="../../../assets/icons/icons.svg#filter"></use>
          </svg>
        </button>
        <div class="filter-menu" *ngIf="showFilterMenu">
          <div class="filter-option">
            <label>Estado:</label>
            <select [(ngModel)]="filterStatus" (change)="applyFilters()">
              <option value="all">Todos</option>
              <option value="paid">Pagadas</option>
              <option value="pending">Pendientes</option>
              <option value="cancelled">Canceladas</option>
            </select>
          </div>
          <div class="filter-option">
            <label>Ordenar por:</label>
            <select [(ngModel)]="sortBy" (change)="applyFilters()">
              <option value="date-desc">Más recientes</option>
              <option value="date-asc">Más antiguos</option>
              <option value="amount-desc">Mayor monto</option>
              <option value="amount-asc">Menor monto</option>
            </select>
          </div>
          <div class="filter-actions">
            <button (click)="resetFilters()" class="reset-button">
              Restablecer filtros
            </button>
          </div>
        </div>
      </div>
    </div>
    <button *ngIf="activeView === 'invoices'" (click)="setActiveView('create')">
      <svg width="24" height="24">
        <use xlink:href="../../../assets/icons/icons.svg#addBox"></use>
      </svg>
      Nueva Factura
    </button>
  </div>

  <!-- Listado de Facturas -->
  <div class="billing-container__content" *ngIf="activeView === 'invoices'">
    <div class="billing-container__table">
      <table>
        <thead>
          <tr>
            <th>Nº Factura</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let invoice of filteredInvoices">
            <td>{{ invoice.number }}</td>
            <td>{{ invoice.clientName }}</td>
            <td>{{ formatDate(invoice.date) }}</td>
            <td>{{ invoice.amount | currency: "UYU" : "symbol" : "1.2-2" }}</td>
            <td>
              <span class="badge" [ngClass]="'badge-' + invoice.status">
                {{
                  invoice.status === "paid"
                    ? "Pagada"
                    : invoice.status === "pending"
                      ? "Pendiente"
                      : "Cancelada"
                }}
              </span>
            </td>
            <td class="actions">
              <button class="action-btn view" (click)="viewInvoice(invoice)">
                <svg width="18" height="18">
                  <use xlink:href="../../../assets/icons/icons.svg#show"></use>
                </svg>
              </button>
              <button
                class="action-btn download"
                (click)="downloadInvoice(invoice.id)"
              >
                <svg width="18" height="18">
                  <use
                    xlink:href="../../../assets/icons/icons.svg#download"
                  ></use>
                </svg>
              </button>
              <button
                class="action-btn email"
                (click)="sendInvoiceByEmail(invoice.id)"
              >
                <svg width="18" height="18">
                  <use xlink:href="../../../assets/icons/icons.svg#mail"></use>
                </svg>
              </button>
              <button
                *ngIf="invoice.status === 'pending'"
                class="action-btn delete"
                (click)="cancelInvoice(invoice.id)"
              >
                <svg width="18" height="18">
                  <use
                    xlink:href="../../../assets/icons/icons.svg#cancel"
                  ></use>
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Crear Factura -->
  <div class="billing-container__content" *ngIf="activeView === 'create'">
    <div class="invoice-form">
      <div class="invoice-form__header">
        <h3>Nueva Factura Electrónica</h3>
        <div class="invoice-logo">
          <img
            src="../../../assets/images/logo_biller.webp"
            alt="Biller.uy Logo"
          />
        </div>
      </div>

      <form (submit)="$event.preventDefault(); createInvoice()">
        <!-- Datos del Cliente -->
        <div class="form-section">
          <h4>Datos del Cliente</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="clientName">Nombre o Razón Social *</label>
              <input
                type="text"
                id="clientName"
                [(ngModel)]="newInvoice.clientName"
                name="clientName"
                required
                [class.is-invalid]="clientNameInvalid"
              />
              <div class="invalid-feedback" *ngIf="clientNameInvalid">
                Nombre del cliente es requerido
              </div>
            </div>

            <div class="form-group">
              <label for="clientRut">RUT *</label>
              <input
                type="text"
                id="clientRut"
                [(ngModel)]="newInvoice.clientRut"
                name="clientRut"
                placeholder="22.345.678-9"
                required
                [class.is-invalid]="clientRutInvalid"
              />
              <div class="invalid-feedback" *ngIf="clientRutInvalid">
                RUT inválido (formato: XX.XXX.XXX-Y)
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="clientEmail">Email *</label>
              <input
                type="email"
                id="clientEmail"
                [(ngModel)]="newInvoice.clientEmail"
                name="clientEmail"
                required
                [class.is-invalid]="clientEmailInvalid"
              />
              <div class="invalid-feedback" *ngIf="clientEmailInvalid">
                Email inválido
              </div>
            </div>

            <div class="form-group">
              <label for="clientAddress">Dirección *</label>
              <input
                type="text"
                id="clientAddress"
                [(ngModel)]="newInvoice.clientAddress"
                name="clientAddress"
                required
                [class.is-invalid]="clientAddressInvalid"
              />
              <div class="invalid-feedback" *ngIf="clientAddressInvalid">
                Dirección es requerida
              </div>
            </div>
          </div>
        </div>

        <!-- Detalles de la Factura -->
        <div class="form-section">
          <h4>Detalles de la Factura</h4>

          <div class="form-group">
            <label for="invoiceDescription">Descripción General *</label>
            <textarea
              id="invoiceDescription"
              [(ngModel)]="newInvoice.description"
              name="invoiceDescription"
              rows="2"
              required
              [class.is-invalid]="descriptionInvalid"
            ></textarea>
            <div class="invalid-feedback" *ngIf="descriptionInvalid">
              Descripción es requerida
            </div>
          </div>

          <div class="invoice-items">
            <h5>Ítems</h5>
            <table class="items-table">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of newInvoice.items; let i = index">
                  <td>
                    <input
                      type="text"
                      [(ngModel)]="item.description"
                      [ngModelOptions]="{ standalone: true }"
                      [class.is-invalid]="itemsInvalid && !item.description"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      [(ngModel)]="item.quantity"
                      [ngModelOptions]="{ standalone: true }"
                      min="1"
                      (change)="updateItemTotal(i)"
                      [class.is-invalid]="itemsInvalid && item.quantity <= 0"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      [(ngModel)]="item.unitPrice"
                      [ngModelOptions]="{ standalone: true }"
                      min="0"
                      (change)="updateItemTotal(i)"
                      [class.is-invalid]="itemsInvalid && item.unitPrice <= 0"
                    />
                  </td>
                  <td>
                    {{
                      calculateItemTotal(item)
                        | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                  <td>
                    <button
                      type="button"
                      class="action-btn delete"
                      (click)="removeInvoiceItem(i)"
                    >
                      <svg width="18" height="18">
                        <use
                          xlink:href="../../../assets/icons/icons.svg#delete"
                        ></use>
                      </svg>
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>Subtotal:</strong>
                  </td>
                  <td>
                    {{
                      calculateSubtotal() | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                  <td></td>
                </tr>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>IVA (22%):</strong>
                  </td>
                  <td>
                    {{ calculateTax() | currency: "UYU" : "symbol" : "1.2-2" }}
                  </td>
                  <td></td>
                </tr>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>Total:</strong>
                  </td>
                  <td>
                    {{
                      calculateTotal() | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
            <button
              type="button"
              class="add-item-btn"
              (click)="addInvoiceItem()"
            >
              <svg width="18" height="18">
                <use xlink:href="../../../assets/icons/icons.svg#plus"></use>
              </svg>
              Agregar Ítem
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="cancel-btn"
            (click)="setActiveView('invoices')"
          >
            Cancelar
          </button>
          <button type="submit" class="submit-btn" [disabled]="isSubmitting">
            <span *ngIf="isSubmitting" class="spinner"></span>
            Generar Factura
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reportes -->
  <div class="billing-container__content" *ngIf="activeView === 'reports'">
    <div class="reports-container">
      <div class="reports-header">
        <h3>Reportes de Facturación</h3>
        <div class="time-range">
          <button
            [class.active]="timeRange === 'week'"
            (click)="setTimeRange('week')"
          >
            Semana
          </button>
          <button
            [class.active]="timeRange === 'month'"
            (click)="setTimeRange('month')"
          >
            Mes
          </button>
          <button
            [class.active]="timeRange === 'quarter'"
            (click)="setTimeRange('quarter')"
          >
            Trimestre
          </button>
          <button
            [class.active]="timeRange === 'year'"
            (click)="setTimeRange('year')"
          >
            Año
          </button>
        </div>
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <div class="card-title">Total Facturado</div>
          <div class="card-value">
            {{ reportData.totalAmount | currency: "UYU" : "symbol" : "1.0-0" }}
          </div>
          <div
            class="card-trend"
            [ngClass]="reportData.amountTrend > 0 ? 'positive' : 'negative'"
          >
            <svg width="16" height="16">
              <use
                [attr.xlink:href]="
                  '../../../assets/icons/icons.svg#' +
                  (reportData.amountTrend > 0 ? 'trending-up' : 'trending-down')
                "
              ></use>
            </svg>
            {{ reportData.amountTrend }}% vs período anterior
          </div>
        </div>

        <div class="summary-card">
          <div class="card-title">Facturas Emitidas</div>
          <div class="card-value">{{ reportData.invoiceCount }}</div>
          <div
            class="card-trend"
            [ngClass]="reportData.countTrend > 0 ? 'positive' : 'negative'"
          >
            <svg width="16" height="16">
              <use
                [attr.xlink:href]="
                  '../../../assets/icons/icons.svg#' +
                  (reportData.countTrend > 0 ? 'trending-up' : 'trending-down')
                "
              ></use>
            </svg>
            {{ reportData.countTrend }}% vs período anterior
          </div>
        </div>

        <div class="summary-card">
          <div class="card-title">Promedio por Factura</div>
          <div class="card-value">
            {{
              reportData.averageAmount | currency: "UYU" : "symbol" : "1.0-0"
            }}
          </div>
          <div
            class="card-trend"
            [ngClass]="reportData.avgTrend > 0 ? 'positive' : 'negative'"
          >
            <svg width="16" height="16">
              <use
                [attr.xlink:href]="
                  '../../../assets/icons/icons.svg#' +
                  (reportData.avgTrend > 0 ? 'trending-up' : 'trending-down')
                "
              ></use>
            </svg>
            {{ reportData.avgTrend }}% vs período anterior
          </div>
        </div>

        <div class="summary-card">
          <div class="card-title">Pendiente de Cobro</div>
          <div class="card-value">
            {{
              reportData.pendingAmount | currency: "UYU" : "symbol" : "1.0-0"
            }}
          </div>
          <div
            class="card-trend"
            [ngClass]="reportData.pendingTrend < 0 ? 'positive' : 'negative'"
          >
            <svg width="16" height="16">
              <use
                [attr.xlink:href]="
                  '../../../assets/icons/icons.svg#' +
                  (reportData.pendingTrend < 0
                    ? 'trending-up'
                    : 'trending-down')
                "
              ></use>
            </svg>
            {{ reportData.pendingTrend }}% vs período anterior
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h4>Facturación por Período</h4>
        <div class="chart-placeholder">
          <!-- Aquí iría un gráfico real con una librería como Chart.js -->
          <div class="chart-mock">
            <div
              class="chart-bar"
              *ngFor="let item of chartData"
              [style.height.%]="item.percentage"
            >
              <div class="bar-tooltip">
                {{ item.value | currency: "UYU" : "symbol" : "1.0-0" }}
              </div>
            </div>
          </div>
          <div class="chart-labels">
            <div class="chart-label" *ngFor="let item of chartData">
              {{ item.label }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver factura -->
  <div class="modal-overlay" *ngIf="showInvoiceModal">
    <div class="modal invoice-modal">
      <div class="modal-header">
        <h3>Factura #{{ selectedInvoice?.number }}</h3>
        <button class="close-btn" (click)="closeInvoiceModal()">
          <svg width="20" height="20">
            <use xlink:href="../../../assets/icons/icons.svg#close"></use>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="invoice-preview">
          <!-- Cabecera de la factura -->
          <div class="invoice-header">
            <div class="company-info">
              <img
                src="assets/biller-logo.png"
                alt="Biller.uy Logo"
                class="invoice-logo"
              />
              <div class="company-details">
                <h4>Factura Electrónica</h4>
                <p>Biller Uruguay S.A.</p>
                <p>RUT: 123456789-0</p>
                <p>Dirección: Av. Principal 123, Montevideo</p>
              </div>
            </div>
            <div class="invoice-details">
              <div class="invoice-number">
                Factura #{{ selectedInvoice?.number }}
              </div>
              <div class="invoice-date">
                Fecha: {{ formatDate(selectedInvoice?.date) }}
              </div>
              <div
                class="invoice-status"
                [ngClass]="'status-' + selectedInvoice?.status"
              >
                {{
                  selectedInvoice?.status === "paid"
                    ? "PAGADA"
                    : selectedInvoice?.status === "pending"
                      ? "PENDIENTE"
                      : "CANCELADA"
                }}
              </div>
            </div>
          </div>

          <!-- Información del cliente -->
          <div class="client-info">
            <h5>Cliente</h5>
            <div class="client-details">
              <p><strong>Nombre:</strong> {{ selectedInvoice?.clientName }}</p>
              <p><strong>RUT:</strong> {{ selectedInvoice?.clientRut }}</p>
              <p><strong>Email:</strong> {{ selectedInvoice?.clientEmail }}</p>
              <p>
                <strong>Dirección:</strong> {{ selectedInvoice?.clientAddress }}
              </p>
            </div>
          </div>

          <!-- Descripción general -->
          <div class="invoice-description">
            <h5>Descripción</h5>
            <p>{{ selectedInvoice?.description }}</p>
          </div>

          <!-- Ítems de la factura -->
          <div class="invoice-items-table">
            <h5>Detalle</h5>
            <table>
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedInvoice?.items">
                  <td>{{ item.description }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>
                    {{ item.unitPrice | currency: "UYU" : "symbol" : "1.2-2" }}
                  </td>
                  <td>
                    {{ item.total | currency: "UYU" : "symbol" : "1.2-2" }}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>Subtotal:</strong>
                  </td>
                  <td>
                    {{
                      selectedInvoice?.subtotal
                        | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                </tr>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>IVA (22%):</strong>
                  </td>
                  <td>
                    {{
                      selectedInvoice?.tax
                        | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                </tr>
                <tr>
                  <td colspan="3" class="text-right">
                    <strong>Total:</strong>
                  </td>
                  <td>
                    {{
                      selectedInvoice?.amount
                        | currency: "UYU" : "symbol" : "1.2-2"
                    }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Pie de la factura -->
          <div class="invoice-footer">
            <div class="qr-code">
              <!-- Simulación de código QR -->
              <div class="qr-placeholder"></div>
              <p>Escanea para verificar</p>
            </div>
            <div class="legal-info">
              <p>Documento Fiscal Electrónico según normativa de DGI</p>
              <p>CAE: {{ selectedInvoice?.cae }}</p>
              <p>
                Vencimiento: {{ formatDate(selectedInvoice?.caeExpiration) }}
              </p>
            </div>
          </div>
        </div>

        <div class="invoice-actions">
          <button
            class="action-btn download"
            (click)="downloadInvoice(selectedInvoice?.id ?? '')"
          >
            <svg width="18" height="18">
              <use xlink:href="../../../assets/icons/icons.svg#download"></use>
            </svg>
            Descargar PDF
          </button>
          <button
            class="action-btn email"
            (click)="sendInvoiceByEmail(selectedInvoice?.id || '')"
          >
            <svg width="18" height="18">
              <use xlink:href="../../../assets/icons/icons.svg#mail"></use>
            </svg>
            Enviar por Email
          </button>
          <button
            *ngIf="selectedInvoice?.status === 'pending'"
            class="action-btn delete"
            (click)="cancelInvoice(selectedInvoice?.id ?? '')"
          >
            <svg width="18" height="18">
              <use xlink:href="../../../assets/icons/icons.svg#delete"></use>
            </svg>
            Cancelar Factura
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
